extends Control

var save_window = preload("res://scenes/save_window.tscn")
var load_window = preload("res://scenes/load_window.tscn")
var delete_window = preload("res://scenes/delete_window.tscn")

var llm = preload("res://scenes/llm.tscn")

var standard_dict = { [["A#0", 400], ["C2", 300]]: [["D1", 600]], [["A#2", 200], ["C3", 200]]: [["D3", 150]], [["A#2", 300], ["C3", 200]]: [["D3", 200]], [["A#3", 150], ["A3", 150]]: [["G3", 200], ["G3", 200], ["G3", 200]], [["A#3", 150], ["C4", 150]]: [["D4", 300], ["A3", 200], ["D4", 300], ["D4", 300]], [["A#3", 150], ["G3", 200]]: [["F3", 200]], [["A#3", 200], ["A3", 150]]: [["G3", 150], ["G3", 150]], [["A#3", 300], ["C4", 200]]: [["A#3", 150]], [["A#3", 300], ["C6", 700]]: [["D6", 300]], [["A#3", 300], ["G3", 200]]: [["A3", 200]], [["A#7", 500], ["D#6", 400]]: [["G2", 350]], [["A0", 600], ["C1", 400]]: [["E1", 400], ["E1", 400], ["D1", 400], ["E1", 400], ["E1", 400], ["E1", 400], ["D1", 400], ["E1", 400], ["E1", 400], ["E1", 400], ["D1", 400], ["E1", 400]], [["A0", 800], ["D1", 500]]: [["E1", 500], ["E1", 500]], [["A1", 500], ["A#0", 400]]: [["C2", 300]], [["A2", 550], ["C5", 600]]: [["D3", 500]], [["A3", 150], ["A#3", 300]]: [["C4", 200]], [["A3", 150], ["G3", 150]]: [["C4", 300], ["F3", 300]], [["A3", 150], ["G3", 200]]: [["D4", 200], ["F3", 200], ["F3", 200]], [["A3", 200], ["B3", 200]]: [["C4", 200], ["D4", 200]], [["A3", 200], ["C4", 150]]: [["A#3", 150]], [["A3", 200], ["C4", 200]]: [["E4", 200]], [["A3", 200], ["F3", 200]]: [["C3", 300], ["D3", 150]], [["A3", 200], ["G3", 200]]: [["C4", 200]], [["A3", 300], ["C4", 200]]: [["A#3", 150]], [["A3", 300], ["F4", 350]]: [["D4", 250]], [["A3", 500], ["B3", 500]]: [["C4", 1000]], [["A3", 500], ["B3", 1000]]: [["C4", 500], ["C4", 500], ["E4", 500]], [["A3", 500], ["G3", 500]]: [["F3", 1000]], [["A3", 500], ["G3", 1000]]: [["F3", 1000]], [["A3", 1000], ["G3", 1000]]: [["A3", 500]], [["A4", 200], ["C5", 200]]: [["A4", 200], ["E5", 200], ["B4", 200]], [["A4", 200], ["F4", 200]]: [["E4", 200], ["D4", 200], ["D4", 200], ["D4", 200]], [["A4", 400], ["A4", 400]]: [["G4", 800]], [["A4", 400], ["B4", 600]]: [["C5", 800]], [["A4", 400], ["C5", 600]]: [["D5", 800]], [["A4", 400], ["F3", 350]]: [["D5", 300]], [["A4", 400], ["G4", 800]]: [["F4", 400]], [["A4", 600], ["B4", 400]]: [["C5", 800]], [["A4", 600], ["B4", 800]]: [["C5", 1200]], [["A4", 800], ["G4", 400]]: [["F#4", 600]], [["A4", 1000], ["E4", 600]]: [["F#4", 400]], [["A4", 1000], ["E5", 600]]: [["D5", 400]], [["A4", 1200], ["G4", 800]]: [["F#4", 600]], [["A5", 800], ["G5", 400]]: [["F#5", 400]], [["A5", 1200], ["G5", 800]]: [["F#5", 600]], [["A6", 700], ["F5", 300]]: [["G6", 500]], [["A7", 500], ["G1", 400]]: [["F2", 500]], [["B3", 200], ["C4", 200]]: [["D4", 200], ["E4", 200], ["D4", 200]], [["B3", 200], ["D4", 200]]: [["F4", 200]], [["B3", 200], ["E5", 500]]: [["G5", 300]], [["B3", 500], ["A3", 500]]: [["G3", 1000]], [["B3", 500], ["A3", 1000]]: [["G3", 1000]], [["B3", 500], ["C4", 1000]]: [["E4", 500]], [["B3", 1000], ["A3", 500]]: [["G3", 500], ["G3", 1000]], [["B3", 1000], ["C4", 500]]: [["D4", 500], ["D4", 500]], [["B3", 1000], ["E4", 500]]: [["F4", 500]], [["B4", 200], ["C5", 200]]: [["B4", 200], ["A4", 200]], [["B4", 200], ["D5", 200]]: [["B4", 200]], [["B4", 200], ["G4", 200]]: [["E4", 200], ["C4", 200], ["F4", 200], ["E4", 200]], [["B4", 400], ["C5", 800]]: [["E5", 1200]], [["B4", 400], ["E3", 300]]: [["G#4", 250]], [["B4", 600], ["C5", 400]]: [["D5", 600]], [["B4", 600], ["C5", 800]]: [["D5", 400]], [["B4", 800], ["A4", 400]]: [["C5", 600]], [["B4", 800], ["A4", 1000]]: [["E4", 600]], [["B5", 400], ["A#3", 300]]: [["C6", 700]], [["B5", 400], ["B7", 600]]: [["A7", 500]], [["B7", 600], ["A7", 500]]: [["G1", 400]], [["C1", 400], ["D1", 400]]: [["A0", 600], ["A0", 600], ["A0", 600]], [["C1", 400], ["E1", 400]]: [["A0", 600], ["F1", 500], ["A0", 800], ["A0", 600], ["F1", 500], ["A0", 800], ["A0", 600], ["F1", 500], ["A0", 1000]], [["C2", 300], ["D1", 600]]: [["D2", 450]], [["C3", 150], ["A#2", 300]]: [["C3", 200]], [["C3", 200], ["D3", 150]]: [["F3", 150], ["F3", 150]], [["C3", 200], ["D3", 200]]: [["G3", 200], ["F3", 200]], [["C3", 200], ["E3", 200]]: [["G3", 200], ["G3", 150], ["G3", 200]], [["C3", 300], ["A#2", 200]]: [["C3", 200]], [["C3", 300], ["D3", 150]]: [["E3", 150]], [["C3", 600], ["A#7", 500]]: [["D#6", 400]], [["C4", 150], ["A#3", 150]]: [["G3", 200]], [["C4", 150], ["A#3", 200]]: [["A3", 150]], [["C4", 150], ["A#3", 300]]: [["G3", 200]], [["C4", 150], ["A3", 200]]: [["F3", 200]], [["C4", 150], ["D4", 300]]: [["G3", 200], ["A3", 200]], [["C4", 200], ["A#3", 150]]: [["A3", 150], ["A3", 150], ["A3", 150]], [["C4", 200], ["A3", 200]]: [["B3", 200], ["B3", 200]], [["C4", 200], ["B3", 200]]: [["C4", 200]], [["C4", 200], ["D4", 200]]: [["F4", 200], ["E4", 200], ["E4", 200], ["E4", 200]], [["C4", 200], ["E4", 200]]: [["G4", 200], ["G4", 200], ["G4", 200]], [["C4", 200], ["G3", 200]]: [["A3", 200]], [["C4", 250], ["B4", 400]]: [["E3", 300]], [["C4", 300], ["D4", 200]]: [["F4", 200]], [["C4", 300], ["E4", 200]]: [["G4", 250]], [["C4", 400], ["D4", 400]]: [["E4", 400], ["E4", 400]], [["C4", 500], ["B3", 500]]: [["A3", 1000]], [["C4", 500], ["B3", 1000]]: [["A3", 500], ["A3", 500]], [["C4", 500], ["D4", 500]]: [["E4", 1000], ["E4", 1000]], [["C4", 800], ["G4", 400]]: [["G4", 400]], [["C4", 1000], ["B3", 500]]: [["A3", 500]], [["C4", 1000], ["E4", 500]]: [["D4", 500]], [["C5", 200], ["A4", 200]]: [["F4", 200], ["F4", 200]], [["C5", 200], ["B4", 200]]: [["G4", 200], ["G4", 200]], [["C5", 200], ["E5", 200]]: [["D5", 200]], [["C5", 400], ["A3", 300]]: [["F4", 350]], [["C5", 400], ["B4", 800]]: [["A4", 400]], [["C5", 400], ["D5", 400]]: [["B4", 800]], [["C5", 400], ["D5", 600]]: [["E5", 400]], [["C5", 600], ["A4", 800]]: [["G4", 400]], [["C5", 600], ["B4", 800]]: [["A4", 1000]], [["C5", 600], ["D3", 500]]: [["E5", 450]], [["C5", 600], ["D5", 800]]: [["E5", 1000]], [["C5", 800], ["A4", 1000]]: [["E5", 600]], [["C5", 800], ["D5", 400]]: [["C5", 600]], [["C5", 800], ["E5", 1200]]: [["D5", 600]], [["C6", 500], ["B5", 400]]: [["B7", 600]], [["C6", 700], ["D6", 300]]: [["C6", 500]], [["D#3", 200], ["G3", 200]]: [["C3", 200]], [["D#4", 150], ["C4", 150]]: [["A#3", 300], ["A#3", 200]], [["D#6", 400], ["G2", 350]]: [["F4", 600]], [["D1", 400], ["A0", 600]]: [["C1", 400], ["C1", 400], ["C1", 400]], [["D1", 500], ["E1", 500]]: [["F1", 500], ["F1", 500]], [["D1", 600], ["D2", 450]]: [["G5", 500]], [["D2", 450], ["G5", 500]]: [["B5", 400]], [["D3", 150], ["C3", 150]]: [["A#2", 300]], [["D3", 150], ["E3", 150]]: [["G3", 150]], [["D3", 150], ["F3", 150]]: [["G3", 300], ["G3", 300]], [["D3", 200], ["F3", 200]]: [["G3", 200]], [["D3", 200], ["G3", 200]]: [["A#3", 150]], [["D3", 300], ["A3", 200]]: [["G3", 200]], [["D3", 300], ["C3", 200]]: [["E3", 200], ["E3", 200]], [["D3", 300], ["C3", 300]]: [["A#2", 200]], [["D3", 500], ["E5", 450]]: [["G#4", 400]], [["D4", 200], ["B3", 200]]: [["C4", 200]], [["D4", 200], ["C4", 200]]: [["B3", 200]], [["D4", 200], ["E4", 200]]: [["F4", 200], ["G4", 200], ["G4", 200]], [["D4", 200], ["F4", 200]]: [["A4", 200], ["A4", 200], ["D#4", 150], ["D#4", 150]], [["D4", 200], ["G4", 200]]: [["E4", 200]], [["D4", 250], ["B3", 200]]: [["E5", 500]], [["D4", 300], ["A3", 200]]: [["F3", 200]], [["D4", 300], ["G3", 200]]: [["F3", 200]], [["D4", 400], ["C4", 800]]: [["G4", 400]], [["D4", 400], ["E4", 400]]: [["F4", 400], ["F4", 400]], [["D4", 500], ["C4", 500]]: [["B3", 1000], ["B3", 1000]], [["D4", 500], ["C4", 1000]]: [["B3", 500]], [["D4", 500], ["E4", 1000]]: [["F4", 500], ["D4", 500]], [["D4", 800], ["C4", 400]]: [["D4", 400]], [["D4", 800], ["G4", 400]]: [["G4", 400]], [["D4", 1000], ["C4", 500]]: [["B3", 500]], [["D5", 200], ["B4", 200]]: [["G4", 200], ["G4", 200]], [["D5", 300], ["C4", 250]]: [["B4", 400]], [["D5", 400], ["C5", 400]]: [["B4", 800]], [["D5", 400], ["C5", 600]]: [["A4", 800], ["B4", 800]], [["D5", 600], ["C5", 400]]: [["D5", 400]], [["D5", 600], ["C5", 800]]: [["A4", 1000]], [["D5", 600], ["E5", 400]]: [["G5", 800], ["F#5", 600]], [["D5", 800], ["E5", 1000]]: [["F#5", 600]], [["D6", 300], ["C6", 500]]: [["B5", 400]], [["E1", 400], ["A0", 600]]: [["C1", 400], ["C1", 400], ["C1", 400]], [["E1", 400], ["A0", 800]]: [["D1", 500], ["D1", 500]], [["E1", 400], ["F1", 500]]: [["E1", 500], ["E1", 500], ["E1", 500]], [["E1", 500], ["A0", 600]]: [["C1", 400], ["C1", 400], ["C1", 400]], [["E1", 500], ["F1", 500]]: [["A0", 600], ["A0", 600]], [["E2", 450], ["F#3", 500]]: [["G4", 400]], [["E3", 150], ["G3", 150]]: [["A3", 150]], [["E3", 200], ["G3", 150]]: [["F3", 150]], [["E3", 200], ["G3", 200]]: [["A#3", 150], ["A#3", 150]], [["E3", 300], ["G#4", 250]]: [["C6", 600]], [["E4", 200], ["C4", 200]]: [["A3", 200], ["G3", 200], ["D4", 200]], [["E4", 200], ["F4", 200]]: [["A4", 200], ["G4", 200]], [["E4", 200], ["G4", 200]]: [["B4", 200], ["B4", 200], ["B4", 200], ["A4", 200], ["F4", 200]], [["E4", 200], ["G4", 250]]: [["C5", 400]], [["E4", 400], ["D4", 400]]: [["C4", 800]], [["E4", 400], ["D4", 800]]: [["G4", 400], ["C4", 400]], [["E4", 400], ["E4", 400]]: [["D4", 400]], [["E4", 400], ["F4", 400]]: [["G4", 800], ["G4", 800]], [["E4", 500], ["D4", 500]]: [["C4", 1000]], [["E4", 500], ["D4", 1000]]: [["C4", 500]], [["E4", 500], ["F4", 500]]: [["G4", 1000]], [["E4", 600], ["F#4", 400]]: [["G4", 800]], [["E4", 800], ["F#4", 400]]: [["A4", 600]], [["E4", 800], ["G4", 600]]: [["A4", 400]], [["E4", 1000], ["D4", 500]]: [["C4", 500], ["C4", 500]], [["E4", 1000], ["F#4", 400]]: [["A4", 600]], [["E4", 1000], ["F4", 500]]: [["G4", 500]], [["E5", 200], ["D5", 200]]: [["B4", 200]], [["E5", 400], ["F#5", 600]]: [["G5", 400]], [["E5", 400], ["G5", 800]]: [["F#5", 400]], [["E5", 450], ["G#4", 400]]: [["A6", 700]], [["E5", 500], ["G5", 300]]: [["A4", 400]], [["E5", 600], ["D5", 400]]: [["C5", 400]], [["E5", 800], ["D5", 400]]: [["C5", 600]], [["E5", 1000], ["F#5", 600]]: [["G5", 400]], [["E5", 1200], ["D5", 600]]: [["C5", 800]], [["F#3", 500], ["G4", 400]]: [["A2", 550]], [["F#4", 400], ["A4", 600]]: [["B4", 400], ["B4", 800]], [["F#4", 400], ["G4", 800]]: [["A4", 1200]], [["F#4", 600], ["E4", 800]]: [["F#4", 400]], [["F#4", 600], ["E4", 1000]]: [["F#4", 400]], [["F#5", 400], ["D5", 600]]: [["E5", 400], ["C5", 400]], [["F#5", 400], ["G5", 400]]: [["A5", 800]], [["F#5", 600], ["E5", 800]]: [["D5", 400]], [["F#5", 600], ["G5", 400]]: [["A5", 1200], ["F#5", 400]], [["F1", 500], ["A0", 600]]: [["C1", 400], ["C1", 400]], [["F1", 500], ["E1", 500]]: [["A0", 600], ["A0", 600], ["A0", 600]], [["F2", 500], ["D3", 600]]: [["E7", 700]], [["F3", 150], ["D3", 300]]: [["A3", 200]], [["F3", 150], ["G3", 300]]: [["A#3", 150], ["A#3", 200]], [["F3", 200], ["C3", 300]]: [["D3", 150]], [["F3", 200], ["D#3", 200]]: [["G3", 200]], [["F3", 200], ["D3", 150]]: [["C3", 150]], [["F3", 200], ["D3", 300]]: [["C3", 200], ["C3", 300], ["C3", 200]], [["F3", 200], ["G3", 200]]: [["A3", 300]], [["F3", 300], ["C3", 200]]: [["D3", 200]], [["F3", 350], ["D5", 300]]: [["C4", 250]], [["F3", 1000], ["G3", 500]]: [["A3", 500], ["A3", 500]], [["F4", 200], ["A4", 200]]: [["C5", 200], ["F4", 200], ["C5", 200]], [["F4", 200], ["C4", 200]]: [["A3", 200]], [["F4", 200], ["D#4", 150]]: [["C4", 150], ["C4", 150]], [["F4", 200], ["D4", 200]]: [["G4", 200], ["B3", 200], ["C4", 200]], [["F4", 200], ["E4", 200]]: [["G4", 200], ["C4", 200]], [["F4", 200], ["G4", 200]]: [["A4", 200]], [["F4", 350], ["D4", 250]]: [["B3", 200]], [["F4", 400], ["E4", 400]]: [["E4", 400], ["D4", 800], ["D4", 800]], [["F4", 400], ["G4", 800]]: [["G4", 400]], [["F4", 500], ["E4", 500]]: [["D4", 1000]], [["F4", 500], ["G4", 500]]: [["E4", 1000]], [["F4", 500], ["G4", 1000]]: [["F4", 500]], [["F4", 600], ["E3", 500]]: [["A7", 700]], [["F5", 300], ["G6", 500]]: [["C3", 600]], [["G#4", 400], ["A6", 700]]: [["F5", 300]], [["G1", 400], ["F2", 500]]: [["D3", 600]], [["G2", 350], ["F4", 600]]: [["E3", 500]], [["G3", 150], ["A3", 150]]: [["A#3", 300]], [["G3", 150], ["C4", 300]]: [["D4", 200]], [["G3", 150], ["F3", 150]]: [["D3", 300]], [["G3", 150], ["F3", 300]]: [["C3", 200]], [["G3", 200], ["A#3", 150]]: [["C4", 150], ["C4", 150], ["C4", 150]], [["G3", 200], ["A3", 200]]: [["C4", 200], ["C4", 150]], [["G3", 200], ["A3", 300]]: [["C4", 200]], [["G3", 200], ["C3", 200]]: [["D3", 150]], [["G3", 200], ["C4", 200]]: [["A#3", 150]], [["G3", 200], ["D4", 200]]: [["F4", 200]], [["G3", 200], ["F3", 200]]: [["D#3", 200], ["D3", 300], ["D3", 300], ["D3", 300]], [["G3", 300], ["A#3", 150]]: [["C4", 150]], [["G3", 300], ["A#3", 200]]: [["A3", 150]], [["G3", 500], ["A3", 500]]: [["B3", 1000], ["B3", 1000], ["B3", 1000]], [["G3", 500], ["F3", 1000]]: [["G3", 500]], [["G3", 1000], ["A3", 500]]: [["B3", 500]], [["G3", 1000], ["F3", 1000]]: [["G3", 500]], [["G4", 200], ["A4", 200]]: [["C5", 200], ["F4", 200]], [["G4", 200], ["B4", 200]]: [["C5", 200], ["D5", 200], ["C5", 200]], [["G4", 200], ["C4", 200]]: [["D4", 200]], [["G4", 200], ["E4", 200]]: [["F4", 200], ["C4", 200], ["C4", 200]], [["G4", 200], ["F4", 200]]: [["E4", 200], ["C4", 200]], [["G4", 250], ["C5", 400]]: [["A3", 300]], [["G4", 400], ["A2", 550]]: [["C5", 600]], [["G4", 400], ["A4", 400]]: [["A4", 400]], [["G4", 400], ["F#4", 600]]: [["E4", 800]], [["G4", 400], ["F4", 400]]: [["E4", 400], ["E4", 400]], [["G4", 400], ["G4", 400]]: [["F4", 400], ["F4", 400]], [["G4", 500], ["E4", 1000]]: [["D4", 500]], [["G4", 600], ["A4", 400]]: [["B4", 600]], [["G4", 800], ["A4", 1200]]: [["G4", 800]], [["G4", 800], ["F#4", 600]]: [["E4", 1000]], [["G4", 800], ["F4", 400]]: [["E4", 400]], [["G4", 800], ["G4", 400]]: [["A4", 400]], [["G4", 1000], ["F4", 500]]: [["E4", 500]], [["G5", 300], ["A4", 400]]: [["F3", 350]], [["G5", 400], ["A5", 800]]: [["G5", 400]], [["G5", 400], ["A5", 1200]]: [["G5", 800]], [["G5", 400], ["F#5", 400]]: [["D5", 600], ["D5", 600]], [["G5", 500], ["B5", 400]]: [["A#3", 300]], [["G5", 800], ["F#5", 400]]: [["G5", 400]], [["G5", 800], ["F#5", 600]]: [["E5", 800]], [["G6", 500], ["C3", 600]]: [["A#7", 500]] }


var started = false
var done_creating = false

var average_produce_time = 2 # technicaly it's below 2 but ... a loading screen looks neat :)
var time_gone = 0

var loaded = false

var song = []
var playing_index = 0
var paused = false

var failed = false

var recommended = ["C3", "D3", "E3", "F3", "G3", "A3", "B3", "C4", "D4", "E4", "F4", "G4", "A4", "B4", "C5", "D5"]

var saved_songs = []
var save_file_path = "user://save/"
var save_file_name = "DataSaver.tres"
var data = Data.new()

func dir_absolute(path):
	DirAccess.make_dir_absolute(path)
func load_saved_songs():
	if FileAccess.file_exists(save_file_path + save_file_name):
		data = ResourceLoader.load(save_file_path + save_file_name)
		saved_songs = data.songs
	else:
		data.change_songs([])
		data.change_dict(standard_dict)
		ResourceSaver.save(data, save_file_path + save_file_name)
		load_saved_songs()
func save_songs():
	data.change_songs(saved_songs)
	ResourceSaver.save(data, save_file_path + save_file_name)

func _ready():
	
	dir_absolute(save_file_path)
	load_saved_songs()
	$"Blocker".hide()
	$"Options".hide()
	$"Pause".hide()
	$"Restart".hide()
	$"Stop".hide()
	
	rcmd_text_green()
	
func _on_back_pressed():
	get_tree().change_scene_to_file("res://scenes/main.tscn")

func start(note):
	$"Disclaimer".hide()
	if not started:
		started = true
		#print(note)
		$"StatusText".text = "Your music is being created.\nEstimated wait time: " + str(average_produce_time) + "s"
		$"Load".hide()
		$"Timer".start()
		updateStatus()
		start_creating(note)
		
		return true
	return false

func updateStatus():
	while not done_creating:
		
		await get_tree().create_timer(randi_range(2,3)).timeout
		
		if not done_creating:
			
			if time_gone > average_produce_time:
				
				if time_gone > average_produce_time + 5:
					$"StatusText".text = "Something is taken a bit longer than expected. \nPlease wait."
				else:
					$"StatusText".text = "Please wait."
			else:
				$"StatusText".text = ["Please wait.", "Estimated wait time: " + str(1+average_produce_time-time_gone) + "s"].pick_random()
				
	$"Timer".stop()
	if not failed:
		$"StatusText".text = "Done! Enjoy your music."
		
		await get_tree().create_timer(1).timeout
		
		$"StatusText".text = ""
		play_song()
	else:
		$"StatusText".text = "Due to not enough data the creating process failed.\nPlease try again with a recommended note."
		await get_tree().create_timer(6).timeout
		get_tree().change_scene_to_file("res://scenes/main_screen.tscn")

func start_creating(note):
	await get_tree().create_timer(randi_range(2,3)).timeout
	
	var llm_inste = llm.instantiate()
	add_child(llm_inste)
	
	song = llm_inste.create(note)
	
	if song != []:
		# Remove repeating end
		var end = []
		for i in range(6):
			end.append(song[-i-1])
		if end.count(song[-1]) == 6:
			for i in range(4):
				song.pop_at(-1)
			
		#print(song)
		done_creating = true
	else:
		done_creating = true
		failed = true
	
func play_song():
	all_text_back()
	$"Disclaimer".hide()
	var piano = $"Piano"
	$"Pause".show()
	$"Pause".text = "Pause"
	var music_notes = song
	var length = len(music_notes)
	#print(music_notes)
	for i in range(int(playing_index), length-1, 1):
		if not paused:
			
			piano.play(music_notes[i][0], music_notes[i][1])
			
			playing_index += 1
			if not paused:
				await get_tree().create_timer(float(music_notes[i][1])/float(1000)).timeout

	$"Pause".disabled = false
	$"Restart".show()
	$"Stop".show()
	
	if not paused:
		
		await get_tree().create_timer(1).timeout
		if loaded:
			$"StatusText".text = "Finished."
		else:
			$"StatusText".text = "Finished. Would you like to save the music?"
			$"Options".show()
			
		$"Pause".hide()
		$"Blocker".show()
		$"Restart".show()
		

func _on_timer_timeout():
	time_gone += 1


func _on_new_pressed():
	get_tree().change_scene_to_file("res://scenes/main_screen.tscn")


func _on_save_pressed():
	var id = (str(song)+str(randf_range(-0.99, 1.99))).hash()

	var element = [id, song]
	var sw_inste = save_window.instantiate()
	
	add_child(sw_inste)
	sw_inste.create(element)
	

func _on_restart_pressed():
	$"Blocker".hide()
	$"Options".hide()
	$"Restart".hide()
	$"Stop".hide()
	$"StatusText".text = ""
	
	playing_index = 0
	paused = false
	
	await get_tree().create_timer(1).timeout
	play_song()


func _on_pause_pressed():
	if not paused:
		$"Pause".disabled = true
		paused = true
		$"Pause".text = "Play"
		
	else:
		paused = false
		$"Restart".hide()
		$"Stop".hide()
		$"Pause".text = "Pause"
		play_song()

func deletion_confirmed(el):
	saved_songs.erase(el)
	save_songs()
	get_tree().change_scene_to_file("res://scenes/main_screen.tscn")
	
func load_e(e):
	song = e[2]
	loaded = true
	started = true
	$"StatusText".text = ""
	$"Load".hide()
	
	await get_tree().create_timer(1).timeout
	
	play_song()

func save_music(e):
	
	saved_songs.append(e)
	save_songs()
	
	$"Options".hide()
	$"Pause".hide()
	$"Restart".hide()
	$"Stop".hide()
	
	$"StatusText".text = "Saved!"
	
	await get_tree().create_timer(2).timeout
	
	get_tree().change_scene_to_file("res://scenes/main_screen.tscn")

func _on_stop_pressed():
	get_tree().change_scene_to_file("res://scenes/main_screen.tscn")

func _on_load_pressed():
	var inste = load_window.instantiate()
	add_child(inste)
	inste.create(saved_songs)

func rcmd_text_green():
	var piano = $"Piano"
	for e in recommended:
		piano.green(e)
func all_text_back():
	var piano = $"Piano"
	for e in recommended:
		piano.back(e)
